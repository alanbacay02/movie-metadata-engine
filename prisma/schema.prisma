/// See `docs/DB_NOTES.md` for TMDb rule compliance, high-level design
/// decisions, and relationship explanations.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum ContentType {
  MOVIE
  TV
}

enum CrewJob {
  DIRECTOR
  WRITER
  PRODUCER
  CINEMATOGRAPHER
  EDITOR
  COMPOSER
}

enum RatingSource {
  TMDB
}

model Movie {
  id          Int         @id @default(autoincrement())
  tmdbId      Int         @unique @map("tmdb_id")
  title       String
  overview    String?     @db.Text
  type        ContentType @default(MOVIE)
  releaseDate DateTime?   @map("release_date")
  language    String?
  runtime     Int?
  posterUrl   String?     @map("poster_url")
  backdropUrl String?     @map("backdrop_url")

  // Relations
  genres  MovieGenre[]
  casts   MovieCast[]
  crew    MovieCrew[]
  ratings Rating[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  lastRefreshedAt DateTime @default(now()) @map("last_refreshed_at")

  @@map("movies")
}

model Genre {
  id     Int          @id @default(autoincrement())
  name   String       @unique
  movies MovieGenre[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  lastRefreshedAt DateTime @default(now()) @map("last_refreshed_at")

  @@map("genres")
}

model MovieGenre {
  movieId Int @map("movie_id")
  genreId Int @map("genre_id")

  movie Movie @relation(fields: [movieId], references: [id], onDelete: Cascade)
  genre Genre @relation(fields: [genreId], references: [id], onDelete: Cascade)

  @@id([movieId, genreId])
  @@map("movie_genres")
}

model Person {
  id     Int    @id @default(autoincrement())
  name   String
  tmdbId Int    @unique @map("tmdb_id")

  casts MovieCast[]
  crews MovieCrew[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  lastRefreshedAt DateTime @default(now()) @map("last_refreshed_at")

  @@map("people")
}

model MovieCast {
  movieId   Int    @map("movie_id")
  personId  Int    @map("person_id")
  character String
  order     Int    @default(0)

  lastRefreshedAt DateTime @default(now()) @map("last_refreshed_at")

  movie  Movie  @relation(fields: [movieId], references: [id], onDelete: Cascade)
  person Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@id([movieId, personId])
  @@map("movie_casts")
}

model MovieCrew {
  movieId  Int    @map("movie_id")
  personId Int    @map("person_id")
  job      String

  lastRefreshedAt DateTime @default(now()) @map("last_refreshed_at")

  movie  Movie  @relation(fields: [movieId], references: [id], onDelete: Cascade)
  person Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@id([movieId, personId])
  @@map("movie_crew")
}

model Rating {
  id          Int          @id @default(autoincrement())
  movieId     Int          @map("movie_id")
  source      RatingSource
  ratingValue Float?       @default(0)
  voteCount   Int?         @default(0)
  popularity  Float?       @default(0)
  voteAverage Float?       @default(0) @map("vote_average")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  lastRefreshedAt DateTime @default(now()) @map("last_refreshed_at")

  movie Movie @relation(fields: [movieId], references: [id], onDelete: Cascade)

  @@map("rating")
}
